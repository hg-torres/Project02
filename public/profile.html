<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="https://cdn.metroui.org.ua/v4.3.2/css/metro-all.min.css">
 
  <link rel="stylesheet" href="profile.css">

  <title>Document</title>
</head>
<body>



  <!-- nav bar -->
  <ul class="h-menu bg-black fg-white">
    <li><a href="./index.html">
        <span class="mif-home mif-lg fg-teal"></span>
        Home
      </a></li>
    <li class="divider"></li>
    <li><a href="./creators.html">
        <span class="mif-users mif-lg fg-pink"></span>
        Creators
      </a></li>
    <li>
      <a href="#" class="dropdown-toggle bg-black fg-white">
        <span id="username" class="mif-user mif-lg fg-amber"></span>
        <span class="mif-arrow-drop-down fg-amber"></span></a>
      <ul class="d-menu bg-black fg-white" data-role="dropdown">
        <li><a href="./profile.html">
            <span class="mif-profile mif-lg fg-violet"></span>
            Profile</a></li>
        <li><a href="./login.html">
            <span class="mif-user-check mif-lg fg-lime"></span>
            Sign In</a></li>
        <li><a href="./register.html">
            <span class="mif-user-plus mif-lg fg-yellow"></span>
            Create Account</a></li>
        <li>
          <a id="logout" class="mif-cross mif-lg fg-red" href="#">  Log Out</a>
          </a>
        </li>
      </ul>
    </li>
  </ul>
    
    <div id="title" >
      <div class="neonText">Profile</div>
    </div>
<div id="mainPage" class="container">
<h2>Your Saved Animes:</h2>
    <div>
    <div id="posts" class="row"></div>
    </div>


  <div id="bottomButton">
    <button type="button" onclick="window.location.href='index.html'"class="button info outline large rounded ">
        <span class="mif-search mif-lg fg-aqua"></span>
        Grow your list!
    </button>
  </div>
</div>




<script src="https://cdn.metroui.org.ua/v4.3.2/js/metro.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

<script>
  var today = new Date();

  var date = today.getFullYear() + '-' + (today.getMonth() + 1) + '-' + today.getDate();
  
  // function for logout user to remove from local storage and send back to login screen
  async function logoutUser() {
    localStorage.removeItem('username')
    localStorage.removeItem('token')
    location = '/login.html'
  }
  document.getElementById('logout').addEventListener('click', logoutUser)
  
  
    // allows profile to be rendered using token, if not sent back to login screen
      async function getProfile() {
        try {
          const { data: user } = await axios.get('/api/users/profile', {
            headers: {
              'Authorization': `Bearer ${localStorage.getItem('token')}`
            }
          })
          return user

        } catch (err) {
          location = '/login.html'
        }
      }
  
   // delete button to remove saved anime from database
    document.addEventListener('click', event => {

      if (event.target.className === 'button alert outline mif-cross-light fg-red') {
        const index = parseInt(event.target.dataset.index)
        console.log(index)
        axios.delete(`./api/animes/${index}`, {
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('token')}`
          }
        })
          .then(() => {

            console.log(event.target.parentNode)
            event.target.parentNode.innerHTML = ''

            console.log('Anime Deleted')
          })
          .catch(err => console.log(err))
      }
    })

    async function renderPost({ id, title, image, rating, synopsis }) {
      const animeElem = document.createElement('div')
      // animeElem.id = "results"
      animeElem.innerHTML = `
        <div id ="results">
          <div class="fade-in">
            <br>
          <img class="img"src='${image}' alt='${title}'">
          </div>
          <h3>${title}</h3>
          <h4>Rating:<span class="mif-star-full fg-yellow"></span> ${rating}</h4>
          <p><strong>Synopsis</strong>: ${synopsis}</p>
          <h6 class="fg-darkGray"> Added on: ${date}</h6> 
      
        </div>
       
          <button id="deleteButton" class="button alert outline mif-cross-light fg-red mx-auto" data-index =${id}>Remove X </button>
      
      `
      document.getElementById('posts').prepend(animeElem)
    }

    async function renderPosts() {

      const { animes } = await getProfile()
      animes.forEach(anime => renderPost(anime))

    }


        // function to retrieve username from local storage. Used to Show name for profile
          async function renderUsername() {
            const username = localStorage.getItem('username')
            
            document.getElementById('username').textContent = username
          }
          renderUsername()

          renderPosts()  
</script>

</body>
</html>
